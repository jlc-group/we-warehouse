-- Fix NULL SKU data in inventory_items table
-- Run this in Supabase SQL Editor

-- 1. Check for NULL or empty SKU values
SELECT 
    id,
    product_name,
    sku,
    location,
    created_at
FROM inventory_items
WHERE sku IS NULL OR sku = ''
ORDER BY created_at DESC
LIMIT 50;

-- 2. Count items with NULL/empty SKU
SELECT 
    COUNT(*) as total_null_sku,
    COUNT(DISTINCT product_name) as unique_products
FROM inventory_items
WHERE sku IS NULL OR sku = '';

-- 3. Fix NULL SKU by generating from product_name
-- Option A: Set SKU to product_name (temporary fix)
UPDATE inventory_items
SET sku = COALESCE(
    NULLIF(sku, ''),
    'SKU-' || SUBSTRING(MD5(product_name || id::text), 1, 8)
)
WHERE sku IS NULL OR sku = '';

-- 4. Verify the fix
SELECT 
    COUNT(*) as items_with_sku,
    COUNT(CASE WHEN sku IS NULL OR sku = '' THEN 1 END) as items_without_sku
FROM inventory_items;

-- 5. Make SKU column NOT NULL (if needed)
-- ALTER TABLE inventory_items ALTER COLUMN sku SET NOT NULL;
