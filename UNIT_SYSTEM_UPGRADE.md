# ЁЯУК Unit System Upgrade - р╕гр╕░р╕Ър╕Ър╕лр╕Щр╣Ир╕зр╕вр╕Щр╕▒р╕Ър╕Чр╕╡р╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М

## ЁЯОп р╕Ыр╕▒р╕Нр╕лр╕▓р╕Чр╕╡р╣Ир╣Бр╕Бр╣Йр╣Др╕В

**р╕Ыр╕▒р╕Нр╕лр╕▓р╣Ар╕Фр╕┤р╕б:** р╕Хр╕▓р╕гр╕▓р╕З `inventory_items` р╣Др╕бр╣Ир╕бр╕╡р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М `unit` р╕Ир╕гр╕┤р╕З р╕Чр╕│р╣Гр╕лр╣Йр╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕лр╕Щр╣Ир╕зр╕вр╕Щр╕▒р╕Ър╣Др╕бр╣Ир╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

**р╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Йр╣Др╕В:** р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М `unit` р╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕░р╕Ър╕Ър╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕лр╕Щр╣Ир╕зр╕вр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

## ЁЯЪА р╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Гр╕лр╕бр╣И

### 1. **р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М unit р╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З inventory_items**
```sql
ALTER TABLE inventory_items
ADD COLUMN IF NOT EXISTS unit TEXT DEFAULT 'р╕Бр╕ер╣Ир╕нр╕З';
```

### 2. **р╕лр╕Щр╣Ир╕зр╕вр╕Щр╕▒р╕Ър╕Чр╕╡р╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ**

| р╕лр╕Щр╣Ир╕зр╕в | Emoji | р╕кр╕╡ | р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З |
|-------|-------|-----|----------|
| р╕ер╕▒р╕З | ЁЯз│ | Blue | р╕Ьр╕Зр╕Лр╕▒р╕Бр╕Яр╕нр╕Б 1 р╕ер╕▒р╕З |
| р╕Бр╕ер╣Ир╕нр╕З | ЁЯУж | Green | р╕вр╕▓р╕кр╕╡р╕Яр╕▒р╕Щ 50 р╕Бр╕ер╣Ир╕нр╕З |
| р╕Кр╕┤р╣Йр╕Щ | ЁЯФ▓ | Purple | р╕кр╕Ър╕╣р╣Ир╕Бр╣Йр╕нр╕Щ 25 р╕Кр╕┤р╣Йр╕Щ |
| р╣Бр╕Ьр╕З | ЁЯУЛ | Indigo | р╕вр╕▓р╣Ар╕бр╣Зр╕Ф 10 р╣Бр╕Ьр╕З |
| р╕Вр╕зр╕Ф | ЁЯН╝ | Cyan | р╕Щр╣Йр╕│р╕Фр╕╖р╣Ир╕б 100 р╕Вр╕зр╕Ф |
| р╕Лр╕нр╕З | ЁЯУж | Pink | р╕Кр╕▓ 50 р╕Лр╕нр╕З |
| р╕лр╕ер╕зр╕б | ЁЯУЭ | Orange | р╣Ар╕ир╕йр╕Хр╣Ир╕▓р╕Зр╣Ж |

### 3. **р╕гр╕░р╕Ър╕Ър╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕лр╕Щр╣Ир╕зр╕вр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤**

#### Function `auto_detect_unit()`:
```sql
CREATE OR REPLACE FUNCTION auto_detect_unit(
    product_name_param TEXT,
    box_qty INTEGER DEFAULT 0,
    loose_qty INTEGER DEFAULT 0
) RETURNS TEXT
```

#### р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕Ир╕▓р╕Бр╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓:
- **р╕ер╕▒р╕З**: р╕Кр╕╖р╣Ир╕нр╕бр╕╡ "р╕ер╕▒р╕З", "carton"
- **р╕Кр╕┤р╣Йр╕Щ**: р╕Кр╕╖р╣Ир╕нр╕бр╕╡ "р╕Кр╕┤р╣Йр╕Щ", "piece", "pcs"
- **р╣Бр╕Ьр╕З**: р╕Кр╕╖р╣Ир╕нр╕бр╕╡ "р╣Бр╕Ьр╕З", "р╣Бр╕Ьр╣Ир╕Щ", "sheet"
- **р╕Вр╕зр╕Ф**: р╕Кр╕╖р╣Ир╕нр╕бр╕╡ "р╕Вр╕зр╕Ф", "bottle"
- **р╕Лр╕нр╕З**: р╕Кр╕╖р╣Ир╕нр╕бр╕╡ "р╕Лр╕нр╕З", "sachet"

#### р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е quantity:
- р╕Цр╣Йр╕▓ `loose_quantity > box_quantity` тЖТ **р╕Кр╕┤р╣Йр╕Щ**
- р╕нр╕╖р╣Ир╕Щр╣Ж тЖТ **р╕Бр╕ер╣Ир╕нр╕З** (default)

### 4. **Trigger р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤**
```sql
CREATE TRIGGER auto_set_unit_trigger
    BEFORE INSERT OR UPDATE ON inventory_items
    FOR EACH ROW
    EXECUTE FUNCTION trigger_auto_set_unit();
```

## ЁЯУК View р╣Гр╕лр╕бр╣Ир╕Чр╕╡р╣Ир╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Бр╕ер╣Йр╕з

### `warehouse_locations_with_inventory` р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕лр╕Щр╣Ир╕зр╕вр╕Др╕гр╕Ъ:
```sql
SELECT
    wl.*,
    inv.total_cartons,     -- ЁЯз│ р╕ер╕▒р╕З
    inv.total_boxes,       -- ЁЯУж р╕Бр╕ер╣Ир╕нр╕З
    inv.total_pieces,      -- ЁЯФ▓ р╕Кр╕┤р╣Йр╕Щ
    inv.total_sheets,      -- ЁЯУЛ р╣Бр╕Ьр╕З
    inv.total_bottles,     -- ЁЯН╝ р╕Вр╕зр╕Ф
    inv.total_sachets,     -- ЁЯУж р╕Лр╕нр╕З
    inv.total_loose,       -- ЁЯУЭ р╕лр╕ер╕зр╕б
    inv.total_quantity_sum -- р╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
FROM warehouse_locations wl
LEFT JOIN (...) inv ON ...
```

## ЁЯОи Frontend UI р╕Чр╕╡р╣Ир╕нр╕▒р╕Ыр╣Ар╕Фр╕Х

### р╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╣Гр╕Щ LocationCard:
```tsx
{location.total_cartons > 0 && (
  <div className="text-blue-600">ЁЯз│ {location.total_cartons} р╕ер╕▒р╕З</div>
)}
{location.total_boxes > 0 && (
  <div className="text-green-600">ЁЯУж {location.total_boxes} р╕Бр╕ер╣Ир╕нр╕З</div>
)}
{location.total_pieces > 0 && (
  <div className="text-purple-600">ЁЯФ▓ {location.total_pieces} р╕Кр╕┤р╣Йр╕Щ</div>
)}
{location.total_sheets > 0 && (
  <div className="text-indigo-600">ЁЯУЛ {location.total_sheets} р╣Бр╕Ьр╕З</div>
)}
{location.total_bottles > 0 && (
  <div className="text-cyan-600">ЁЯН╝ {location.total_bottles} р╕Вр╕зр╕Ф</div>
)}
{location.total_sachets > 0 && (
  <div className="text-pink-600">ЁЯУж {location.total_sachets} р╕Лр╕нр╕З</div>
)}
{location.total_loose > 0 && (
  <div className="text-orange-600">ЁЯУЭ {location.total_loose} р╕лр╕ер╕зр╕б</div>
)}
```

## ЁЯУЛ р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З

### 1. р╕гр╕▒р╕Щ Migration Script:
```sql
-- р╕гр╕▒р╕Щр╣Др╕Яр╕ер╣М add_unit_column_migration.sql р╣Гр╕Щ Supabase SQL Editor
```

### 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:
```sql
-- р╕Фр╕╣р╕Бр╕▓р╕гр╕Бр╕гр╕░р╕Ир╕▓р╕вр╕лр╕Щр╣Ир╕зр╕вр╣Гр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
SELECT unit, COUNT(*) as р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕г
FROM inventory_items
GROUP BY unit
ORDER BY COUNT(*) DESC;
```

### 3. р╕Лр╕┤р╕Зр╕Др╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕е:
```sql
SELECT sync_inventory_to_warehouse_locations();
```

## ЁЯФД р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╣Гр╕лр╕бр╣И

### р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е:

#### р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣Ир╣Ар╕Вр╣Йр╕▓р╕гр╕░р╕Ър╕Ъ:
```sql
INSERT INTO inventory_items (
    product_name, box_quantity, loose_quantity, location
) VALUES (
    'р╕Ьр╕Зр╕Лр╕▒р╕Бр╕Яр╕нр╕Б ABC р╕ер╕▒р╕З 24 р╕Цр╕╕р╕З', 1, 0, 'A1/1'
);
-- тЖТ unit р╕Ир╕░р╕Цр╕╣р╕Бр╕Хр╕▒р╣Йр╕Зр╣Ар╕Ыр╣Зр╕Щ 'р╕ер╕▒р╕З' р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
```

#### р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Гр╕Щ warehouse_locations_with_inventory:
```
р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З A/1/01:
тФЬтФАтФА ЁЯз│ 5 р╕ер╕▒р╕З (р╕Ьр╕Зр╕Лр╕▒р╕Бр╕Яр╕нр╕Б ABC р╕ер╕▒р╕З)
тФЬтФАтФА ЁЯУж 120 р╕Бр╕ер╣Ир╕нр╕З (р╕вр╕▓р╕кр╕╡р╕Яр╕▒р╕Щ, р╕кр╕Ър╕╣р╣Ир╣Ар╕лр╕ер╕з)
тФЬтФАтФА ЁЯФ▓ 45 р╕Кр╕┤р╣Йр╕Щ (р╕кр╕Ър╕╣р╣Ир╕Бр╣Йр╕нр╕Щ, р╣Ар╕ир╕йр╕Хр╣Ир╕▓р╕Зр╣Ж)
тФЬтФАтФА ЁЯУЛ 10 р╣Бр╕Ьр╕З (р╕вр╕▓р╣Ар╕бр╣Зр╕Ф)
тФЬтФАтФА ЁЯН╝ 50 р╕Вр╕зр╕Ф (р╕Щр╣Йр╕│р╕Фр╕╖р╣Ир╕б)
тФЬтФАтФА ЁЯУж 30 р╕Лр╕нр╕З (р╕Кр╕▓р╕Ьр╕З)
тФЬтФАтФА ЁЯУЭ 8 р╕лр╕ер╕зр╕б (р╣Ар╕ир╕йр╕нр╕╖р╣Ир╕Щр╣Ж)
тФФтФАтФА ЁЯУК р╕гр╕зр╕б: 268 р╕лр╕Щр╣Ир╕зр╕в
```

## ЁЯОК р╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣Мр╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ъ

### 1. **р╕Др╕зр╕▓р╕бр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З 100%**
- р╣Гр╕Кр╣Йр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М `unit` р╕Ир╕гр╕┤р╕Зр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З
- р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Фр╕▓р╕Ир╕▓р╕Бр╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓

### 2. **р╕Др╕зр╕▓р╕бр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ**
- р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕лр╕Щр╣Ир╕зр╕вр╕Щр╕▒р╕Ър╕лр╕ер╕▓р╕Бр╕лр╕ер╕▓р╕в
- р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕Др╕гр╕Ър╕Чр╕╕р╕Бр╕лр╕Щр╣Ир╕зр╕в

### 3. **р╕гр╕░р╕Ър╕Ър╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤**
- р╕Хр╕▒р╣Йр╕Зр╕лр╕Щр╣Ир╕зр╕вр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣И
- р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х view р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

### 4. **UI р╕Чр╕╡р╣Ир╕кр╕зр╕вр╕Зр╕▓р╕б**
- Emoji р╣Бр╕Хр╣Ир╕ер╕░р╕лр╕Щр╣Ир╕зр╕в
- р╕кр╕╡р╕Ыр╕гр╕░р╕Ир╕│р╕лр╕Щр╣Ир╕зр╕в
- р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╣Ар╕Ыр╣Зр╕Щр╕гр╕░р╣Ар╕Ър╕╡р╕вр╕Ъ

## ЁЯФз р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓р╣Ар╕Фр╕┤р╕б

### р╕Бр╣Ир╕нр╕Щр╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф:
```
р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З A/1/01:
тФЬтФАтФА ЁЯУж 123 р╕Бр╕ер╣Ир╕нр╕З (р╕Ьр╕кр╕бр╕Чр╕╕р╕Бр╕лр╕Щр╣Ир╕зр╕в)
тФЬтФАтФА ЁЯФ▓ 45 р╕Кр╕┤р╣Йр╕Щ (р╣Ар╕Фр╕▓р╕Ир╕▓р╕Бр╣Ар╕ир╕й)
тФФтФАтФА ЁЯУЭ 8 р╕лр╕ер╕зр╕б
```

### р╕лр╕ер╕▒р╕Зр╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф:
```
р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З A/1/01:
тФЬтФАтФА ЁЯз│ 5 р╕ер╕▒р╕З (р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З 100%)
тФЬтФАтФА ЁЯУж 65 р╕Бр╕ер╣Ир╕нр╕З (р╣Бр╕вр╕Бр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ)
тФЬтФАтФА ЁЯФ▓ 45 р╕Кр╕┤р╣Йр╕Щ (р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З)
тФЬтФАтФА ЁЯУЛ 10 р╣Бр╕Ьр╕З (р╕лр╕Щр╣Ир╕зр╕вр╣Гр╕лр╕бр╣И)
тФЬтФАтФА ЁЯН╝ 50 р╕Вр╕зр╕Ф (р╕лр╕Щр╣Ир╕зр╕вр╣Гр╕лр╕бр╣И)
тФФтФАтФА ЁЯУж 30 р╕Лр╕нр╕З (р╕лр╕Щр╣Ир╕зр╕вр╣Гр╕лр╕бр╣И)
```

## ЁЯОп Next Steps

1. **р╕гр╕▒р╕Щ migration script** р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М unit
2. **р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ** р╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╕лр╕Щр╣Ир╕зр╕в
3. **р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕б** р╣Гр╕лр╣Йр╕бр╕╡р╕лр╕Щр╣Ир╕зр╕вр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
4. **р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ UI** р╕зр╣Ир╕▓р╣Бр╕кр╕Фр╕Зр╕лр╕Щр╣Ир╕зр╕вр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

**р╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕гр╕░р╕Ър╕Ър╕лр╕Щр╣Ир╕зр╕вр╕Щр╕▒р╕Ър╕Чр╕╡р╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣Мр╣Бр╕ер╣Йр╕з!** ЁЯЪА